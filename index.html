<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Interactive Family Tree</title>

  <style>
    :root{
      --ocean:#0F7B7F;
      --sky:#4BB3C3;
      --sand:#F6EFE6;
      --coral:#E76F51;
      --palm:#2A9D8F;
      --sun:#F4A261;
      --indigo:#264653;
      --white:#FFFFFF;

      --border: rgba(38,70,83,.16);
      --shadow: 0 10px 30px rgba(38,70,83,.10);
      --radius: 16px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--indigo);
      background: linear-gradient(135deg, var(--sand), #FFF9F1);
    }

    .topbar{
      position: sticky;
      top:0;
      z-index:10;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 16px;
      background: rgba(255,255,255,.75);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border);
    }

    .brand{ display:flex; gap:12px; align-items:center; }
    .brand__badge{
      width:44px;height:44px;border-radius:14px;
      display:grid; place-items:center;
      background: linear-gradient(135deg, var(--sun), var(--coral));
      color:var(--white); font-size:20px;
      box-shadow: var(--shadow);
    }
    .brand__title{ font-weight:800; }
    .brand__sub{ font-size:13px; color: rgba(38,70,83,.75); }

    .wrap{ max-width: 1100px; margin: 18px auto; padding: 0 16px 40px; }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: rgba(255,255,255,.88);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .card--hero{ padding:18px; }
    .card__titleRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    h1{ margin:0 0 6px; font-size: 24px; color: var(--ocean); }
    h2{ margin:0; font-size: 18px; color: var(--ocean); }
    h3{ margin:0; color: var(--ocean); }

    .muted{ color: rgba(38,70,83,.75); }
    .small{ font-size: 13px; }

    .pill{
      font-size:12px;
      font-weight:700;
      padding:6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(15,123,127,.25);
      background: rgba(15,123,127,.10);
      color: var(--ocean);
    }
    .pill--sun{
      border-color: rgba(244,162,97,.35);
      background: rgba(244,162,97,.15);
      color: #8A4B18;
    }
    .pill--ocean{
      border-color: rgba(79,179,195,.35);
      background: rgba(79,179,195,.15);
      color: var(--ocean);
    }
    .pill--palm{
      border-color: rgba(42,157,143,.35);
      background: rgba(42,157,143,.12);
      color: var(--palm);
    }

    .actions{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
    }
    .actions--right{ justify-content:flex-end; }

    .btn{
      border:1px solid var(--border);
      background: var(--white);
      color: var(--indigo);
      padding:10px 12px;
      border-radius: 12px;
      font-weight:700;
      cursor:pointer;
    }
    .btn:hover{ filter: brightness(.98); }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
    }

    .btn-primary{
      border:none;
      color: var(--white);
      background: linear-gradient(135deg, var(--ocean), var(--sky));
    }
    .btn-secondary{
      border:none;
      color: var(--white);
      background: linear-gradient(135deg, var(--sky), var(--palm));
    }
    .btn-danger{
      border:none;
      color: var(--white);
      background: linear-gradient(135deg, var(--coral), #E85D4F);
    }
    .btn-ghost{
      background: rgba(79,179,195,.12);
      border: 1px dashed rgba(79,179,195,.50);
      color: var(--ocean);
    }

    .field{ display:grid; gap:8px; }
    .field__label{ font-weight:800; }
    .field__help{ font-size:13px; color: rgba(38,70,83,.75); }
    input[type="file"]{
      padding:10px;
      border-radius:12px;
      border:1px solid rgba(38,70,83,.25);
      background: rgba(255,255,255,.8);
    }

    .hero{
      display:flex;
      gap:16px;
      justify-content:space-between;
      align-items:flex-start;
    }
    @media (max-width:900px){ .hero{ flex-direction:column; } }

    .stepper{
      min-width: 340px;
      display:grid;
      gap:10px;
    }
    .step{
      display:flex;
      gap:10px;
      padding:12px;
      border-radius: 14px;
      border: 1px solid rgba(15,123,127,.20);
      background: rgba(246,239,230,.55);
    }
    .step__badge{
      width:30px; height:30px;
      display:grid; place-items:center;
      border-radius: 10px;
      font-weight:900;
      background: var(--sand);
      border: 1px solid rgba(15,123,127,.35);
      color: var(--ocean);
    }
    .step.done .step__badge{
      background: var(--palm);
      border-color: var(--palm);
      color: var(--white);
    }
    .step__title{ font-weight:900; }
    .step__hint{ font-size:12px; color: rgba(38,70,83,.75); }

    .previewGrid{
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:12px;
    }
    @media (max-width:900px){ .previewGrid{ grid-template-columns:1fr; } }

    .previewBox{
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(255,255,255,.7);
      overflow:hidden;
    }
    .previewBox__title{
      font-weight:900;
      padding:10px 12px;
      background: rgba(79,179,195,.12);
      border-bottom: 1px solid var(--border);
    }
    .previewBox__body{ padding:12px; }

    .code{
      margin:0;
      padding:12px;
      font-size: 12px;
      background: rgba(38,70,83,.06);
      overflow:auto;
      max-height: 220px;
    }

    .statusRow{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      margin-top:10px;
    }
    .statusItem{
      flex:1;
      min-width: 160px;
      border:1px solid var(--border);
      border-radius: 14px;
      padding:12px;
      background: rgba(255,255,255,.7);
    }
    .statusItem__label{ font-size:12px; color: rgba(38,70,83,.70); font-weight:800; }
    .statusItem__value{ font-size:22px; font-weight:900; color: var(--indigo); }

    .toast{
      position: fixed;
      right: 16px;
      bottom: 16px;
      padding: 12px 14px;
      border-radius: 14px;
      color: var(--white);
      background: linear-gradient(135deg, var(--indigo), var(--ocean));
      box-shadow: var(--shadow);
      max-width: 380px;
    }

    .help, .confirm{
      border: none;
      border-radius: 18px;
      width: min(720px, 92vw);
      padding: 0;
      box-shadow: var(--shadow);
    }
    .help::backdrop, .confirm::backdrop{
      background: rgba(0,0,0,.45);
    }
    .help__header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:14px 16px;
      background: linear-gradient(135deg, rgba(15,123,127,.16), rgba(79,179,195,.14));
      border-bottom: 1px solid var(--border);
    }
    .help__content{ padding: 14px 16px 18px; }

    .callout{
      margin-top: 12px;
      padding: 12px;
      border-radius: 14px;
      border: 1px dashed rgba(244,162,97,.55);
      background: rgba(244,162,97,.12);
    }
    .callout__title{ font-weight:900; margin-bottom:6px; }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <div class="brand__badge">üå¥</div>
      <div class="brand__text">
        <div class="brand__title">Interactive Family Tree</div>
        <div class="brand__sub">Beginner-friendly ‚Ä¢ Caribbean style ‚Ä¢ Cloud + device save</div>
      </div>
    </div>
    <button class="btn btn-ghost" id="btnHelp" type="button">Help</button>
  </header>

  <main class="wrap">
    <section class="card card--hero">
      <div class="hero">
        <div>
          <h1>Start Here</h1>
          <p class="muted">
            Follow these steps in order. Buttons unlock as you go.
            ‚ÄúShared Tree‚Äù is the cloud copy. ‚ÄúMy Saved‚Äù is only on this device.
          </p>
        </div>

        <div class="stepper" aria-label="Setup steps">
          <div class="step" id="step1">
            <div class="step__badge">1</div>
            <div class="step__text">
              <div class="step__title">Choose a GEDCOM file</div>
              <div class="step__hint">Example: <code>.ged</code> exported from Ancestry/FamilySearch.</div>
            </div>
          </div>
          <div class="step" id="step2">
            <div class="step__badge">2</div>
            <div class="step__text">
              <div class="step__title">Preview & confirm</div>
              <div class="step__hint">We show counts and a sample before saving.</div>
            </div>
          </div>
          <div class="step" id="step3">
            <div class="step__badge">3</div>
            <div class="step__text">
              <div class="step__title">Save / Share</div>
              <div class="step__hint">Save to device or update the shared (cloud) tree.</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="grid">
      <section class="card">
        <div class="card__titleRow">
          <h2>Get the Family Tree</h2>
          <span class="pill">Cloud + Device</span>
        </div>

        <div class="actions">
          <button class="btn btn-secondary" id="btnLoadShared" type="button">Load Shared Tree</button>
          <button class="btn" id="btnLoadLocal" type="button">Load My Saved (This Device)</button>
          <button class="btn btn-danger" id="btnClearLocal" type="button">Clear My Saved</button>
        </div>

        <p class="muted small">
          Tip: Use <strong>Load Shared Tree</strong> first if you want the latest cloud copy.
        </p>
      </section>

      <section class="card">
        <div class="card__titleRow">
          <h2>Upload a GEDCOM</h2>
          <span class="pill pill--sun">Step 1</span>
        </div>

        <label class="field">
          <span class="field__label">Choose your GEDCOM file</span>
          <input id="fileInput" type="file" accept=".ged,.txt" />
          <span class="field__help">If your file is huge, this may take a moment.</span>
        </label>

        <div class="actions">
          <button class="btn btn-primary" id="btnPreview" type="button" disabled>Preview File</button>
        </div>
      </section>
    </section>

    <section class="card" id="previewCard" hidden>
      <div class="card__titleRow">
        <h2>Preview</h2>
        <span class="pill pill--ocean">Step 2</span>
      </div>

      <div class="previewGrid">
        <div class="previewBox">
          <div class="previewBox__title">Counts</div>
          <div class="previewBox__body" id="counts"></div>
        </div>

        <div class="previewBox">
          <div class="previewBox__title">Sample (first people)</div>
          <pre class="code" id="sample"></pre>
        </div>
      </div>

      <div class="actions">
        <button class="btn btn-secondary" id="btnUploadShared" type="button" disabled>Update Shared Tree (Cloud)</button>
        <button class="btn" id="btnSaveLocal" type="button" disabled>Save to My Device</button>
        <button class="btn btn-ghost" id="btnCancelPreview" type="button">Cancel</button>
      </div>

      <p class="muted small">
        Cloud save updates the shared tree for everyone who loads the shared copy.
      </p>
    </section>

    <section class="card">
      <div class="card__titleRow">
        <h2>Current Tree</h2>
        <span class="pill pill--palm" id="treeSourcePill">Not loaded</span>
      </div>

      <div class="statusRow">
        <div class="statusItem">
          <div class="statusItem__label">People</div>
          <div class="statusItem__value" id="statPeople">‚Äî</div>
        </div>
        <div class="statusItem">
          <div class="statusItem__label">Families</div>
          <div class="statusItem__value" id="statFamilies">‚Äî</div>
        </div>
        <div class="statusItem">
          <div class="statusItem__label">Surnames</div>
          <div class="statusItem__value" id="statSurnames">‚Äî</div>
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="btnExportJson" type="button" disabled>Export JSON</button>
        <button class="btn" id="btnExportCsv" type="button" disabled>Export CSV</button>
        <button class="btn btn-danger" id="btnClearLoaded" type="button" disabled>Clear Loaded Tree</button>
      </div>
    </section>
  </main>

  <dialog class="help" id="helpDialog">
    <div class="help__header">
      <h3>How to use this app (Beginner guide)</h3>
      <button class="btn btn-ghost" id="btnCloseHelp" type="button">Close</button>
    </div>

    <div class="help__content">
      <ol>
        <li><strong>Load Shared Tree</strong> to see what‚Äôs already in the cloud.</li>
        <li>To add new data: <strong>Choose File ‚Üí Preview ‚Üí Update Shared Tree</strong>.</li>
        <li><strong>Save to My Device</strong> keeps a copy only on this computer.</li>
        <li>If something looks wrong, click <strong>Cancel</strong> during preview.</li>
      </ol>

      <div class="callout">
        <div class="callout__title">Troubleshooting</div>
        <ul>
          <li>If upload fails: check Netlify env vars and redeploy.</li>
          <li>If shared load returns empty: upload once to create the shared row.</li>
        </ul>
      </div>
    </div>
  </dialog>

  <div class="toast" id="toast" role="status" aria-live="polite" hidden></div>

  <dialog class="confirm" id="confirmDialog">
    <div style="padding:14px 16px; border-bottom:1px solid var(--border); background: rgba(246,239,230,.6)">
      <h3 id="confirmTitle">Confirm</h3>
    </div>
    <div style="padding:14px 16px 0">
      <p id="confirmText" class="muted"></p>
    </div>
    <div class="actions actions--right" style="padding: 0 16px 16px">
      <button class="btn btn-ghost" id="confirmCancel" type="button">Cancel</button>
      <button class="btn btn-danger" id="confirmOk" type="button">Yes, continue</button>
    </div>
  </dialog>

  <script>
    // ========= CONFIG =========
    const ENDPOINTS = {
      getShared: "/.netlify/functions/getSharedTree",
      uploadShared: "/.netlify/functions/uploadTree",
    };
    const LOCAL_KEY = "lafaries_family_tree_v1";

    // ========= ELEMENTS =========
    const $ = (id) => document.getElementById(id);

    const fileInput = $("fileInput");
    const btnPreview = $("btnPreview");

    const previewCard = $("previewCard");
    const countsEl = $("counts");
    const sampleEl = $("sample");

    const btnUploadShared = $("btnUploadShared");
    const btnSaveLocal = $("btnSaveLocal");
    const btnCancelPreview = $("btnCancelPreview");

    const btnLoadShared = $("btnLoadShared");
    const btnLoadLocal = $("btnLoadLocal");
    const btnClearLocal = $("btnClearLocal");

    const treeSourcePill = $("treeSourcePill");
    const statPeople = $("statPeople");
    const statFamilies = $("statFamilies");
    const statSurnames = $("statSurnames");

    const btnExportJson = $("btnExportJson");
    const btnExportCsv = $("btnExportCsv");
    const btnClearLoaded = $("btnClearLoaded");

    const toast = $("toast");

    const step1 = $("step1");
    const step2 = $("step2");
    const step3 = $("step3");

    const helpDialog = $("helpDialog");
    const btnHelp = $("btnHelp");
    const btnCloseHelp = $("btnCloseHelp");

    const confirmDialog = $("confirmDialog");
    const confirmTitle = $("confirmTitle");
    const confirmText = $("confirmText");
    const confirmCancel = $("confirmCancel");
    const confirmOk = $("confirmOk");

    // ========= STATE =========
    let parsedTree = null;
    let loadedTree = null;

    // ========= TOAST =========
    function showToast(message, ms = 2600) {
      toast.textContent = message;
      toast.hidden = false;
      setTimeout(() => (toast.hidden = true), ms);
    }

    // ========= CONFIRM =========
    function confirmAction(title, text) {
      return new Promise((resolve) => {
        confirmTitle.textContent = title;
        confirmText.textContent = text;

        const cleanup = () => {
          confirmCancel.onclick = null;
          confirmOk.onclick = null;
          confirmDialog.close();
        };

        confirmCancel.onclick = () => { cleanup(); resolve(false); };
        confirmOk.onclick = () => { cleanup(); resolve(true); };

        confirmDialog.showModal();
      });
    }

    // ========= GEDCOM PARSER =========
    function parseGedcom(text) {
      const lines = text.split(/\\r?\\n/);
      const people = [];
      const families = [];

      let current = null;
      let currentType = null;

      function commit() {
        if (!current) return;
        if (currentType === "INDI") people.push(current);
        if (currentType === "FAM") families.push(current);
        current = null;
        currentType = null;
      }

      for (const rawLine of lines) {
        const line = rawLine.trim();
        if (!line) continue;

        const m = line.match(/^(\\d+)\\s+(@[^@]+@)?\\s*([A-Z0-9_]+)\\s*(.*)$/);
        if (!m) continue;

        const level = Number(m[1]);
        const xref = m[2] || "";
        const tag = m[3];
        const rest = (m[4] || "").trim();

        if (level === 0 && rest === "INDI") {
          commit();
          currentType = "INDI";
          current = {
            id: xref,
            name: "",
            sex: "",
            birt: { date: "", place: "" },
            deat: { date: "", place: "" },
            famc: [],
            fams: [],
          };
          continue;
        }
        if (level === 0 && rest === "FAM") {
          commit();
          currentType = "FAM";
          current = {
            id: xref,
            husb: "",
            wife: "",
            chil: [],
            marr: { date: "", place: "" },
          };
          continue;
        }
        if (level === 0 && tag === "TRLR") {
          commit();
          break;
        }

        if (!current) continue;

        if (currentType === "INDI") {
          if (tag === "NAME") current.name = rest.replace(/\\//g, "").trim();
          else if (tag === "SEX") current.sex = rest;
          else if (tag === "FAMC") current.famc.push(rest);
          else if (tag === "FAMS") current.fams.push(rest);
          else if (tag === "BIRT") { current.__inBIRT = true; current.__inDEAT = false; }
          else if (tag === "DEAT") { current.__inDEAT = true; current.__inBIRT = false; }
          else if (tag === "DATE") {
            if (current.__inBIRT) current.birt.date = rest;
            if (current.__inDEAT) current.deat.date = rest;
          } else if (tag === "PLAC") {
            if (current.__inBIRT) current.birt.place = rest;
            if (current.__inDEAT) current.deat.place = rest;
          }
        }

        if (currentType === "FAM") {
          if (tag === "HUSB") current.husb = rest;
          else if (tag === "WIFE") current.wife = rest;
          else if (tag === "CHIL") current.chil.push(rest);
          else if (tag === "MARR") current.__inMARR = true;
          else if (tag === "DATE" && current.__inMARR) current.marr.date = rest;
          else if (tag === "PLAC" && current.__inMARR) current.marr.place = rest;
        }
      }
      commit();

      const surnames = new Set();
      for (const p of people) {
        const parts = (p.name || "").split(" ").filter(Boolean);
        if (parts.length) surnames.add(parts[parts.length - 1].toLowerCase());
      }

      return {
        title: "Interactive Family Tree",
        people,
        families,
        stats: { people: people.length, families: families.length, surnames: surnames.size }
      };
    }

    function setStepDone(stepEl, done) {
      stepEl.classList.toggle("done", !!done);
    }

    function setLoadedTree(tree, sourceLabel) {
      loadedTree = tree;

      treeSourcePill.textContent =
        sourceLabel === "shared" ? "Loaded: Shared (Cloud)"
        : sourceLabel === "local" ? "Loaded: My Saved (Device)"
        : sourceLabel === "preview" ? "Loaded: Preview"
        : "Not loaded";

      statPeople.textContent = tree?.stats?.people ?? "‚Äî";
      statFamilies.textContent = tree?.stats?.families ?? "‚Äî";
      statSurnames.textContent = tree?.stats?.surnames ?? "‚Äî";

      const hasTree = !!tree;
      btnExportJson.disabled = !hasTree;
      btnExportCsv.disabled = !hasTree;
      btnClearLoaded.disabled = !hasTree;
    }

    function downloadFile(filename, content, mime = "application/json") {
      const blob = new Blob([content], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function toCsv(tree) {
      const header = ["id","name","sex","birt_date","birt_place","deat_date","deat_place"];
      const rows = [header];

      for (const p of tree.people || []) {
        rows.push([
          p.id || "",
          (p.name || "").replaceAll('"', '""'),
          p.sex || "",
          p.birt?.date || "",
          (p.birt?.place || "").replaceAll('"', '""'),
          p.deat?.date || "",
          (p.deat?.place || "").replaceAll('"', '""'),
        ]);
      }
      return rows.map(r => r.map(v => `"${String(v)}"`).join(",")).join("\\n");
    }

    async function fetchJson(url, options) {
      const res = await fetch(url, options);
      const text = await res.text();
      let json = null;
      try { json = text ? JSON.parse(text) : null; } catch {}
      if (!res.ok) {
        const msg = json?.error || json?.message || text || `Request failed (${res.status})`;
        throw new Error(msg);
      }
      return json;
    }

    // ========= HELP =========
    btnHelp.addEventListener("click", () => helpDialog.showModal());
    btnCloseHelp.addEventListener("click", () => helpDialog.close());

    // ========= Step 1 =========
    fileInput.addEventListener("change", () => {
      const hasFile = fileInput.files && fileInput.files.length > 0;
      btnPreview.disabled = !hasFile;

      setStepDone(step1, hasFile);
      setStepDone(step2, false);
      setStepDone(step3, false);

      previewCard.hidden = true;
      parsedTree = null;
    });

    // ========= Step 2 =========
    btnPreview.addEventListener("click", async () => {
      const file = fileInput.files?.[0];
      if (!file) return;

      showToast("Reading file‚Ä¶");
      const text = await file.text();

      try {
        parsedTree = parseGedcom(text);
      } catch (e) {
        console.error(e);
        showToast("Could not parse this GEDCOM. Try exporting again.");
        return;
      }

      countsEl.innerHTML = `
        <div><strong>People:</strong> ${parsedTree.stats.people}</div>
        <div><strong>Families:</strong> ${parsedTree.stats.families}</div>
        <div><strong>Surnames:</strong> ${parsedTree.stats.surnames}</div>
      `;

      const sample = (parsedTree.people || []).slice(0, 6).map(p => ({
        id: p.id, name: p.name, birt: p.birt, deat: p.deat
      }));
      sampleEl.textContent = JSON.stringify(sample, null, 2);

      previewCard.hidden = false;
      btnUploadShared.disabled = false;
      btnSaveLocal.disabled = false;

      setStepDone(step2, true);
      setLoadedTree(parsedTree, "preview");

      showToast("Preview ready. If it looks correct, save or share.");
    });

    btnCancelPreview.addEventListener("click", () => {
      previewCard.hidden = true;
      btnUploadShared.disabled = true;
      btnSaveLocal.disabled = true;
      parsedTree = null;
      setStepDone(step2, false);
      showToast("Preview canceled.");
    });

    // ========= Step 3: Save Local =========
    btnSaveLocal.addEventListener("click", async () => {
      if (!parsedTree) return;

      const ok = await confirmAction(
        "Save to this device?",
        "This will save the tree in your browser on this computer only."
      );
      if (!ok) return;

      localStorage.setItem(LOCAL_KEY, JSON.stringify(parsedTree));
      setStepDone(step3, true);
      showToast("Saved to this device.");
    });

    // ========= Step 3: Upload Shared =========
    btnUploadShared.addEventListener("click", async () => {
      if (!parsedTree) return;

      const ok = await confirmAction(
        "Update the Shared Tree (Cloud)?",
        "This will replace the shared cloud copy for everyone who loads it."
      );
      if (!ok) return;

      btnUploadShared.disabled = true;
      showToast("Uploading to cloud‚Ä¶");

      try {
        await fetchJson(ENDPOINTS.uploadShared, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id: 1, data: parsedTree })
        });

        setStepDone(step3, true);
        showToast("Shared tree updated successfully.");
      } catch (e) {
        console.error(e);
        showToast(`Upload failed: ${e.message}`);
      } finally {
        btnUploadShared.disabled = false;
      }
    });

    // ========= Load Shared =========
    btnLoadShared.addEventListener("click", async () => {
      showToast("Loading shared tree‚Ä¶");
      try {
        const json = await fetchJson(ENDPOINTS.getShared);
        if (!json?.data) {
          showToast("Shared tree is empty. Upload one first.");
          return;
        }
        setLoadedTree(json.data, "shared");
        showToast("Shared tree loaded.");
      } catch (e) {
        console.error(e);
        showToast(`Could not load shared tree: ${e.message}`);
      }
    });

    // ========= Load Local =========
    btnLoadLocal.addEventListener("click", () => {
      const raw = localStorage.getItem(LOCAL_KEY);
      if (!raw) {
        showToast("No saved tree found on this device.");
        return;
      }
      try {
        const tree = JSON.parse(raw);
        setLoadedTree(tree, "local");
        showToast("Loaded your saved tree.");
      } catch {
        showToast("Your saved tree is corrupted. Clear it and save again.");
      }
    });

    // ========= Clear Local =========
    btnClearLocal.addEventListener("click", async () => {
      const ok = await confirmAction(
        "Clear your saved copy?",
        "This removes only the device copy (it does not affect the shared cloud tree)."
      );
      if (!ok) return;

      localStorage.removeItem(LOCAL_KEY);
      showToast("Saved copy cleared.");
    });

    // ========= Export =========
    btnExportJson.addEventListener("click", () => {
      if (!loadedTree) return;
      downloadFile("family-tree.json", JSON.stringify(loadedTree, null, 2), "application/json");
    });

    btnExportCsv.addEventListener("click", () => {
      if (!loadedTree) return;
      downloadFile("family-tree-people.csv", toCsv(loadedTree), "text/csv");
    });

    // ========= Clear Loaded =========
    btnClearLoaded.addEventListener("click", async () => {
      const ok = await confirmAction(
        "Clear loaded tree from screen?",
        "This only clears the current view (it does not delete cloud or device data)."
      );
      if (!ok) return;

      setLoadedTree(null, null);
      showToast("Cleared current view.");
    });

    // initial
    setLoadedTree(null, null);
  </script>
</body>
</html>
